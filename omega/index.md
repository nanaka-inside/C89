Title: TWE-liteで簡単無線通信
Subtitle: じたばた丸計画第二回中間報告
Author: @omegamega
Author(romaji): おめが

<!--
編集上、この上の行はこのまま残しておいてね
本番のファイルは index.md で作ってね
-->

# じたばた丸計画第二回中間報告

## 前回までのあらすじ

「市販の1/700のフルハル軍艦模型を、ラジコン操作して遊びたい！できるなら将来的には自動運転もしたいし、やっぱりPC連携ね！」という欲で始まった「じたばた丸計画」。水面ギリギリに浮かぶラジコン半潜水艦「じたばた丸」を作り、その上に軍艦模型を乗せ浮力を調整すれば、水面の反射が潜水艦を隠してくれてかなりイイ感じに模型を泳がせることが可能であることまでは実証できました。ラジコン半潜水艦を作るコンセプトの正しさは証明できました。
ラジコン艦は、無線制御の中核にはTOCOS製TWE-lite無線マイコンモジュールを中核に、タミヤ製水中モーターを2軸を駆動させるのが基本構造としました。技術検証艦である1号艦では、とりあえずの食品保蔵用の100円タッパーに電池と回路一式を詰め込み、TOCOS提供のTWE-liteサンプルアプリにてコマンドを送信、ごくごく低速かつ船体制御は低いものの実際の動作に成功しました。また、近所の公園じゃぶじゃぶ池海域での試験航海も(流されながらも)無事達成することができました。次なる2号艦は船体を3Dプリントで生産し(プロトタイプを2回3Dプリントし、第3船体を実用として作成)、今後の量産に耐えうる仕様、モーター出力の向上、制御性能の向上をメイン目標として作りました。しかし、水密が難しいという潜水艦特有の問題が起きてしまい、そのまま原稿締め切りが来てしまった、というところで終わっていました。

今回はその続き、2号艦の船体/回路改良と、TWE-lite制御アプリを作った話になります。

# 2号艦・第3船体

前回の記事では、2号艦(電装系)と第3プリント船体は、水密試験がうまくい行かないところまでで終わっていました。
ざっくり変更点を書きますと、

* 1号艦
 * 非力な単三1本(アルカリ)の1.5Vモーター電源
 * DRV777モータードライバによる順方向のみ。単方向推進
* 2号艦
 * 強力な単三3本(エネループ)の3.6Vモーター電源
 * BD6211Fモータードライバによる順方向/逆方向制御。逆進可能

というのが大きな違いになります。共通の仕様としては、TWE-lite無線マイコンの電源はCR2032ボタン電池を使用していることぐらいで、ほぼ新規になっています。

もう一方の第3プリント船体は、モックの第1船体、パーツ擦り合わせ確認用の第2船体に続く、今回初めて作成した3Dプリンタ製の船体です。プリンタの最大出力寸法の都合であまり鋭角なシルエットではありませんが、真四角のタッパーよりは流水に対して抵抗の少ない形状と、水中モーターを違和感なく固定できる固定穴や、電池ボックスや回路をぴったり格納できる内部構造をもっています。主機となるタミヤ水中モーターは電池ボックス部を取り除き、モーター端子にケーブルをはんだ付けした上で、船体にホットボンドで固定しました。
2号艦電装は水中モーターとコネクタで電気的につないだ後、この第3船体内部に格納して、ゴムシートを張ったフタで閉じ、輪ゴムでぐるぐる巻きにして固定します。ゴムシートはAmazonで見つけましたが、一部のホームセンターでも取り扱いがあるようです。ゴムシートの密着面にはグリスを塗って、しっかり水密できるようにしました。したつもりでした。

うちで使っている3DプリンタはUp!Plus2で、このプリンタの最大出力寸法が12cm角程度なため、全長15cm近くある船体を吐くためには出力エリアに斜めに配置しなければなりません。これ以上の船体拡張も難しいため、より大きな出力範囲を持つプリンタが欲しくなりますが、オサイフ的には気軽に買えないのが難しいですね。より大型のものが必要になれば、パーツ分割をして個別出力後に接着となるでしょう。実際この後そうなりました。

## 水密検証による死亡

前回の記事でもかいたように、水を張った洗面台にて水密試験をしました。フタのグリスを追加したりしましたが結局ダメ。ホットボンドで固定した、モーター付近から水が入ってきてしまっているようでした。念のためタミヤ水中モーター自体の水密も確認(ちゃんとした船であればグリスを詰めたスタンションチューブでプロペラ軸を支えるが、水中モーターはCリングとグリスで水密していた)したが、結局問題なし。ということは、ホットボンドで固定した部分、船体と水中モーターの間が怪しそうです。
しかし、水揚げ後に1か月程度放置していたところ、どうやらモーターがさび付いてしまったようで、モーターがうんともすんとも動かなくなってしまいました。進水できないという残念な結果ですが、この船体は破棄するとし、モーターと船体の固定方法を考えなおすこととしました。
 
 ## 3Dプリント船体は浮力オーバー
 
これは予想外の問題でした。DFM式3Dプリントの場合、内部を中空に成形します。これが船の場合フロートとして有効なのですが、今回作るのはほぼ潜水艦。余計なフロートによって過剰な浮力が生まれてしまいました。
鉄球をオモリとして仕込めるように作ってはありましたが、試してみると重さが全然足りません。
 
# 第4船体
## 改良ポイント

水密に難があった第3船体のマイナーチェンジとして作成しました。水中モーターと船体の間が水密の問題となることから

* 水中モーターの本来のねじ込み構造を残す
* 水中モーターは船体から取り外し、乾燥や交換が可能なようにする

としました。具体的には、水中モーターの電池ボックス部を切断して、その部分を接着剤で船体に取り付け、モーターはそこにねじ込む仕様です。こうすることで、水中モーターが元々持つ水密ゴムパッキンやねじ込み部分を、じたばた丸の水密構造へ取り込みました。
一応水密をどうするか

# pythonによる制御アプリjitabata_server

前回の動作試験ではTOCOS公式がTWE-lite検証用に提供していたWindowsアプリで制御してましたが、友人@greenspaがpythonアプリを作ってくれたため、WebからGUIによる操作ができるようになりました。
python製のhttpdアプリとウェブページに分かりており、ウェブページを適当な端末(そのまま立ち上がっているPC)で開き、各種ボタンを操作するとpython製のhttpdサーバのAPIを叩き、それがシリアル通信をしてTWE-liteの通信となる。といった仕組みです。APIとウェブページ(UI)を分けておくことで、後のカスタマイズがし易いだろうという目論見です。

## 公園じゃぶじゃぶ池海域での試験航海

いつもの公園にて。

# 試験航海からの反省

## 水密に問題はなし

水中モーターを接着、ねじ込み式にしたのは正解でこの部位からの浸水はありませんでした。
フタ部に関しても、グリスをたっぷり塗りこめば大丈夫な様子。3Dプリント船体はかなり有用なようです。

## 直進性がない

モーター出力を両舷とも同じにして直進にしても、半径1mぐらいで旋回してしまいます。旋回性は高いというよりは、その場でぐるぐる超信地旋回してしまうレベル。
まっすぐ進めない方が遥かに問題でした。

## 推力がオーバーパワー

そのまま、TWE-liteの1024段階出力のうち、半分の512ですら早すぎる感じでした。また高すぎる出力は次の問題も起こしてしまいました。

## 推力が高すぎるとき、船体が沈んでしまう

じたばた丸は安定性を重視して鉄球のウエイトを船体下に配置したため、重心が推力中心より下になっています。ここに高すぎる出力が加わると、船体に前のめりの回転が働いてしまい、そのまま潜水してしまうことが分かりました。
さらに、TWE-liteは電波途絶したとき、最後の状態を保持しつづける仕様があります(標準アプリの場合)。潜水すると水の高い電波遮蔽によって必ず電波が途絶してしまうのですが、最後の状態を保持するので潜水したまま暴走し、池の底を走り続けてしまうのです。

## ウエイト調整が面倒

鉄球ウエイトを回路や電池と同じ空間に配置してしまったことによる問題です。回路と電池の下に鉄球が入っているため、浮力を調整するためには

* フタを固定している輪ゴムを外して、船体のフタをあける
* 回路と電池を取り出す
* 鉄球を入れる/減らす
* 回路と電池を戻す
* フタを戻して輪ゴムで固定する。必要に応じてフタにグリスを塗り直す

という手間がありました。水密区画を開け閉めするのは非常に面倒な作業な上、浸水の原因になってしまいます。水密区画である回路側は電源を入れたらそのままフタをしてしまい、遊び終わるまでフタを開けずに済むのが理想です。

## 前三角の浮力が過剰

# 第4号船体改良
## 直進性の改善、L/B比の話

まず一番謎だった問題から調べました、直進性です。
おそらくこの辺は船体の形状だろうということは検討付いていました。というのも、2軸推進で推力を調整して進む船というのは一般的な船ではありませんが、それほどタグボートなどでは採用例があり変ではありません。一方でじたばた丸の第4船体のような、前後が非常に短い船は現実にはあまり見かけません。まずはここから試べてみました。
ググっていると、戦後50年ぐらいの船体の歴史を語っているpdf資料(http://www.jasnaoe.or.jp/zousen-siryoukan/2010/100827-hanawa/100827-hanawa.pdf)を見つけることができました。ざっくりいうと、船体の設計は船体の水線長(長さ)と幅の比率L/B比というのがあり、L/B比が高く細い船体であるほど直進性に優れて水の抵抗が少なく、L/B比が小さく太い船体ほど旋回性能に優れて抵抗が大きい、というものでした。その資料ではさらに、船首の造波から生まれる波に乗るような低抵抗の船底構造や、そのシミュレート、造船技術の進歩による近代の船の省エネっぷり(具体例では100年前の豪華客船タイタニックと、近代の船を比較すると近代の船は、船底形状のみで抵抗が30%も削減されていて機関出力も相応に下がっている、など)が語られるなど、非常に興味深い資料でした。
ここではとりあえずじたばた丸L/B比にだけ注目してみます。先のpdfによると、古くの貨客船ではスピードが重視されL/B比が8～7の細い船体が主流だったり、逆に戦艦大和などはL/B比6.4と太め、現代のコンテナ貨物船では7.0～6.4、バラ積み貨物船では6.3～5.3程度だそうです。一方で約全長13cm幅6cmのじたばた丸第4船体のL/B比は約2.1、これはさすがに小さい。ということで前後に水中翼を付けて、船体を長くしてL/B比を改善します。
調べてみると、ラジコンボートや小型ヨットでも船体バランス調整に翼を付けることがあるようです。どうやら自分たちが気づくのが遅かっただけで、この辺の技術は一般的なようですね…。前後それぞれに6cm程度の翼を付けることで、約全長25cm、L/Bは4.1になりました。

# 改良船体での試験航海

池を走らせてみると、ずいぶんと操作しやすくなりました。

# 第5号船体
## モジュラリティの向上
## 浮力調整

第3船体で前三角の浮力が大きいことが問題でした。オモリで浮力を相殺する

## ウエイトトレイ

# 2号電装改良・推力調整
# nodejsによる制御アプリjitabata_serverjs

ステータス表示

# 2号艦+第5船体
## じゃぶじゃぶ池海域での試験航海
# 試験航海からの反省

# 開発は続く